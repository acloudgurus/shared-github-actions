---
prev:
    text: Test
    link: '../'
next:
    false
---
zilvertonz/shared-github-actions/test/python
===========================================================

A GitHub action to run Pytest on Python scripts then output coverage and JUNIT-XML reports

### Assumptions

+ Python version >=3.10 installed via [UV](https://docs.astral.sh/uv/). Current shared runner defaults to 3.10, and would require running `actions/setup-python` to specify a different version from 3.10. To install via UV in Github Actions, see example below.
+ An existing pyproject.toml within the repository.
+ If using pipenv, An existing Pipfile is within the repository. 
+ If using Poetry, existing poetry configurations are set in pyproject.toml
+ Unit tests are created and existing for Python scripts. Specific pytest configurations within pyproject.toml

### Permissions

+ `contents: read`
  + Required to read contents

### Inputs

+ `toml_parent_dir`
  + Points to directory containing PyProject TOML file to use. Defaults to `.`. Can be comma-separated for multiple pytest location runs.
  + type: `string`
+ `environment_usage`
  + Setting for python package manager used for dependencies. Currently supported are `pip`, `poetry`, `pipenv`. Defaults to `pip`. `poetry` recommended.
  + type: `string`
+ `debug_mode`
  + If true, will output more logging even on successful tests. Defaults to `false`
  + type: `boolean`
+ `additional_args`
  + Extra space-separated arguments to pass to Pytest command. Defaults to `""`
  + type: `string`
+ `coverage_gate`
  + Code Coverage Gate checked after pytest. Minimum quality gate is 80%. Required for Path-To-Prod.
  + type: `number`

### Outputs

+ `junit_report_path`
  + Location of JUnit Report XML generated by Pytest. Comma-separated paths if multiple pytest locations run."
+ `coverage_report_path`
  + Location to HTML report generated by Coverage for use, accumulates coverage of all runs.
+ `coverage_score`
  + Percentage of total coverage generated by coverage report.


### Using this action (default)

To use this action, make a workflow file in `.github/workflows` and use it in a job definition:
```
name: Test Python Scripts
env:
  SHELL_ENVIRONMENT: poetry
  TOML_PARENT_DIR:  ${{ inputs.toml_parent_dir || 'module/aws/glue_code' }}
  WHL_LOCATION: './dist/example-project-1.1.0.whl'


on:
  workflow_dispatch:

permissions:
  contents: write
  checks: write

jobs:
  TestPython:
    runs-on: MA-Analytics-Runner
    steps:
    - uses: actions/checkout@v4
    - name: Set up python 3.10
      id: py_setup
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        uv python pin 3.10
    - name: Install Dependencies
      id: install_deps
      uses: zilvertonz/shared-github-actions/install/python@v1
      with:
        environment_usage: ${{ env.SHELL_ENVIRONMENT }}
        toml_parent_dir: ${{ env.TOML_PARENT_DIR }}
        whl_package_path: ${{ env.WHL_LOCATION }}
        additional_dependencies: 'numpy pandas pyarrow'
    - name: Test with pytest
      id: test_python
      uses: zilvertonz/shared-github-actions/test/python@v1
      with:
        toml_parent_dir: ${{ env.TOML_PARENT_DIR }}
        debug_mode: ${{ inputs.debug_mode }}
        environment_usage: ${{ env.SHELL_ENVIRONMENT }}
    - name: Publish Test Report
      id: publish_junit
      uses: mikepenz/action-junit-report@db71d41eb79864e25ab0337e395c352e84523afe
      if: success() || failure()
      with:
        report_paths: ${{ steps.test_python.outputs.junit_report_path }}
        include_passed: true
        fail_on_failure: true
        update_check: true
        commit: ${{github.event.workflow_run.head_sha}}

```

This workflow will run a job `TestPython` which will fail if toml_parent_dir is invalid, or environment used does not have requirements set for it. The step `Install Dependencies` will install the python project. The subsequent step `Test with pytest` will run [Pytest command](https://docs.pytest.org/en/stable/) and with output on junit-xml report, and will run [Coverage command](https://coverage.readthedocs.io/en/7.6.1/) with an html report generated. Both reports are passed as an output. `Publish Test Report` utilizes [mikepenz/action-junit-report](https://github.com/mikepenz/action-junit-report) to publish a check report of the junit report.